@using System.Data @*importar librerias para la vista y manejo de menus*@
@{
    ViewBag.Title = "Departamento";
    var dt = ViewBag.Departamentos as DataTable; /*// DataTable que contiene los departamentos*/
    var dt_historial = ViewBag.Historial as DataTable; /*// DataTable que contiene el historial de movimientos*/
    var dt_asignar = ViewBag.Asignar as DataTable; 
}


@section styles { @*/*ara realizar filtros, busquedas , exportar a .xlsx, cvs, pdf, etc.*/*@
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" />
}


<head>
    <link rel="stylesheet" href="~/Content/css/Departamento.css" />
</head>


<section class="app">
    <!-- Menú lateral -->
    <aside class="sidebar" aria-label="Menú de secciones">
        <h3 id="menuTitle">Gestor de Departamentos</h3>
        <nav class="nav" aria-labelledby="menuTitle">
            <a href="@($"{Url.Action("Agregar","Departamento")}#agregar")" aria-describedby="agregarDesc">Crear</a>
            <a href="@($"{Url.Action("Consultar","Departamento")}#consultar")" aria-describedby="consultarDesc">Consultar</a>
            <a href="@($"{Url.Action("Asignar","Departamento")}#asignar")" aria-describedby="asignarDesc">Asignar</a>
            <a href="@($"{Url.Action("Historial","Departamento")}#historial")" aria-describedby="historialDesc">Historial</a>
        </nav>

        <!-- Descripciones invisibles para accesibilidad -->
        <p id="agregarDesc" class="muted" hidden>Crear un nuevo departamento</p>
        <p id="consultarDesc" class="muted" hidden>Lista de departamentos existentes</p>
        <p id="asignarDesc" class="muted" hidden>Asignar empleados a un departamento</p>
        <p id="historialDesc" class="muted" hidden>Ver movimientos entre departamentos</p>
    </aside>

    <!-- Contenido -->
    <main class="content">
        @*<h2 class="page-title">Gestor de Departamentos</h2>*@

        <!-- Agregar -->
        <section id="agregar" class="section" aria-labelledby="agregarTitle">

            <h3 id="agregarTitle">Cree un nuevo departamento</h3>
            @*<form action="@Url.Action("Departamento","Departamento")" method="post" novalidate>*@ @*// para cuando no se usa script para descargar documentos*@ 
            <form action="@Url.Action("Agregar","Departamento")" method="post" novalidate>
                @Html.AntiForgeryToken()

                <div class="form-grid">
                    <div class="form-row">
                        @*<label for="nombreDepar">nombre del departamento</label>*@
                        <input id="nombreDepar"
                               name="nombreDepar"
                               type="text"
                               maxlength="50"
                               required
                               placeholder="Sistemas, Marketing, Recursos Humanos, etc." />
                    </div>

                    <div class="actions">
                        <button type="submit">Enviar</button>
                        @*<button type="reset" class="ghost">Cancelar</button>*@
                    </div>
                </div>
            </form>
        </section>




        <!-- Consultar -->
        <section id="consultar" class="section" aria-labelledby="consultarTitle">
            <h3 id="consultarTitle">Lista de departamentos existentes</h3>

            @*<form action="@Url.Action("Consultar","Departamento")" method="get" class="mb-2">
            <button type="submit">Actualizar lista</button>
        </form>*@

            @* Bloque de tabla basado en DataTable *@
            @if (dt != null && dt.Rows.Count > 0)
            {
                @*<table class="table">*@
                <table id="tablaDeptos" class="table dt-auto" data-title="Departamentos" style="width:100%">
                    @*para realizar filtros, busquedas , exportar a .xlsx, cvs, pdf, etc.*@

                    <thead>
                        <tr>
                            @foreach (System.Data.DataColumn col in dt.Columns)
                            {
                                <th>@col.ColumnName</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (System.Data.DataRow row in dt.Rows)
                        {
                            <tr>
                                @foreach (var val in row.ItemArray)
                                {
                                    <td>@val</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="muted">No hay departamentos para mostrar.</p>
            }


        </section>


            <!-- ASIGNAR -->
            <section id="asignar" class="section" aria-labelledby="asignarTitle">
                <h3 id="asignarTitle">Asignar departamento a empleado</h3>
                <p class="muted">Formulario de asignación de empleados.</p>

                <form action="@Url.Action("Asignar","Departamento")" method="post" novalidate>
                    @Html.AntiForgeryToken()

                    <!-- Campo visible para CONSULTAR -->
                    <div class="form-row">
                        <input id="cedulaEmpl"
                               name="cedulaEmpl"
                               type="text"
                               maxlength="50"
                               required
                               value="@(ViewBag.CedulaEmpl ?? "")"
                               placeholder="Cédula del empleado" />
                    </div>

                    <!-- Campo visible para ASIGNAR -->
                    <div class="form-row">
                        <input id="dept_no_nuevo"
                               name="dept_no_nuevo"
                               type="number"
                               placeholder="Nuevo departamento (ID)" />
                    </div>

                    <!-- Hidden que se rellenan tras CONSULTAR -->
                    <input type="hidden" name="emp_no" value="@ViewBag.EmpNo" />
                    <input type="hidden" name="dept_no_actual" value="@ViewBag.DeptNoActual" />

                    <div class="actions">
                        <button type="submit" name="accion" value="consultar">Consultar</button>
                        <button type="submit" name="accion" value="asignar" @(ViewBag.EmpNo == null ? "disabled" : null)>Asignar</button>
                    </div>
                </form>

                @* Tabla simple de resultados de la consulta *@
           
                @if (dt_asignar != null && dt_asignar.Rows.Count > 0)
                {
                    <table id="tablaAsignar" class="table" style="width:100%">
                        <thead>
                            <tr>
                                @foreach (System.Data.DataColumn col in dt_asignar.Columns)
                                {
                                    <th>@col.ColumnName</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (System.Data.DataRow row in dt_asignar.Rows)
                            {
                                <tr>
                                    @foreach (var val in row.ItemArray)
                                    {
                                        <td>@val</td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="muted">No hay empleados para mostrar.</p>
                }
            </section>

            <!-- Historial -->
            <section id="historial" class="section" aria-labelledby="historialTitle">
                <h3 id="historialTitle">Historial de movimientos</h3>

                @* Bloque de tabla basado en DataTable *@
                @if (dt_historial != null && dt_historial.Rows.Count > 0)
                {
                    @*<table class="table">*@
                    <table id="tablaHistorial" class="table dt-auto" data-title="Historial de movimientos" style="width:100%">
                        @*para realizar filtros, busquedas , exportar a .xlsx, cvs, pdf, etc.*@

                        <thead>
                            <tr>
                                @foreach (System.Data.DataColumn col in dt_historial.Columns)
                                {
                                    <th>@col.ColumnName</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (System.Data.DataRow row in dt_historial.Rows)
                            {
                                <tr>
                                    @foreach (var val in row.ItemArray)
                                    {
                                        <td>@val</td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="muted">Historial de movimientos del empleado entre áreas o departamentos.</p>
                }

            </section>
</main>
</section>

@*Script para realizar filtros, busquedas , exportar a .xlsx, cvs, pdf, etc.*@
@section scripts {
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <script>
        $(function () {
            $('table.dt-auto').each(function () {
                var $t = $(this);
                $t.DataTable({
                    responsive: true,
                    scrollX: true,
                    dom: 'Bfrtip',
                    buttons: [
                        { extend: 'copyHtml5', title: $t.data('title') || document.title },
                        { extend: 'excelHtml5', title: $t.data('title') || document.title },
                        { extend: 'csvHtml5', title: $t.data('title') || document.title },
                        { extend: 'pdfHtml5', title: $t.data('title') || document.title, orientation: 'landscape', pageSize: 'A4' },
                        { extend: 'print', title: $t.data('title') || document.title }
                    ],
                    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' }
                });
            });
        });
    </script>
}